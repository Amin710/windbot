# راهنمای قفل کانال (Force Join)

## مشکل شما
قفل کانال کار نمی‌کند و کاربرانی که عضو کانال نیستند، همچنان می‌توانند از ربات استفاده کنند.

## راه‌حل
قابلیت قفل کانال (Force Join) به ربات شما اضافه شده است. برای فعال‌سازی آن:

## 1. راه‌اندازی اولیه

### نصب تنظیمات در پایگاه داده:
```bash
python setup_force_join.py
```

### یا دستی در پایگاه داده:
```sql
-- فعال کردن قفل کانال
INSERT INTO settings (key, val) VALUES ('force_join_enabled', 'true')
ON CONFLICT (key) DO UPDATE SET val = EXCLUDED.val;

-- اضافه کردن کانال‌ها (با کاما جدا شوند)
INSERT INTO settings (key, val) VALUES ('required_channels', '@your_channel,@another_channel')
ON CONFLICT (key) DO UPDATE SET val = EXCLUDED.val;
```

## 2. تنظیم کانال‌ها

### فرمت‌های مجاز برای کانال‌ها:
- `@channel_username` - برای کانال‌های عمومی
- `-1001234567890` - برای کانال‌های خصوصی (ID عددی)
- `channel_username` - بدون @

### مثال:
```
@windscribe_official,-1001234567890,support_channel
```

## 3. تنظیم مجوزهای ربات

**مهم:** ربات باید در تمام کانال‌ها ادمین باشد و مجوزهای زیر را داشته باشد:
- ✅ **مشاهده پیام‌ها**
- ✅ **مشاهده اعضا** 
- ✅ **اضافه کردن کاربران** (اختیاری)

## 4. restart ربات
```bash
# بعد از تغییر تنظیمات، ربات را restart کنید
python bot.py
```

## نحوه کارکرد

1. **کاربر جدید** دستور `/start` می‌زند
2. **ربات** عضویت او در کانال‌ها را بررسی می‌کند
3. **اگر عضو نباشد**: پیام عضویت + دکمه‌های join نمایش داده می‌شود
4. **اگر عضو باشد**: منوی اصلی نمایش داده می‌شود
5. **دکمه "✅ بررسی عضویت"** برای بررسی مجدد

## تست کارکرد

### بررسی تنظیمات فعلی:
```bash
python setup_force_join.py
# انتخاب گزینه 1 - مشاهده تنظیمات فعلی
```

### تست با کاربر غیرعضو:
1. کاربری که عضو کانال نیست `/start` بزند
2. باید پیام عضویت ببیند
3. بعد از عضویت، "✅ بررسی عضویت" بزند
4. باید منوی اصلی نمایش داده شود

## عیب‌یابی

### اگر قفل کانال کار نمی‌کند:

1. **بررسی تنظیمات پایگاه داده:**
```sql
SELECT * FROM settings WHERE key IN ('force_join_enabled', 'required_channels');
```

2. **بررسی ادمین بودن ربات:**
   - رفته به کانال
   - آیا ربات ادمین است؟
   - آیا مجوز "مشاهده اعضا" دارد؟

3. **بررسی فرمت کانال:**
   - برای کانال‌های عمومی: `@channel_name`
   - برای کانال‌های خصوصی: ID عددی مثل `-1001234567890`

4. **بررسی لاگ‌های ربات:**
```bash
tail -f bot.log | grep -i "channel\|membership\|force"
```

5. **restart مجدد ربات:**
```bash
# کشتن فرآیند قبلی
pkill -f bot.py
# راه‌اندازی مجدد
python bot.py
```

## کدهای اضافه شده

### فایل‌های جدید:
- `setup_force_join.py` - اسکریپت تنظیمات
- `FORCE_JOIN_README.md` - این راهنما

### تابع‌های اضافه شده در `bot.py`:
- `load_force_join_settings()` - بارگذاری تنظیمات
- `check_channel_membership()` - بررسی عضویت  
- `get_channel_join_keyboard()` - ایجاد کیبورد عضویت
- `send_join_channels_message()` - ارسال پیام عضویت

### تغییرات در `callback_handler`:
- بررسی عضویت قبل از پردازش callback ها
- callback ویژه `check_membership`

### تغییرات در `start` function:
- بررسی عضویت قبل از نمایش منوی اصلی

## پشتیبانی

اگر همچنان مشکل دارید:
1. لاگ کامل ربات را ارسال کنید
2. تنظیمات پایگاه داده را بررسی کنید
3. مطمئن شوید ربات در کانال‌ها ادمین است 